<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fram & Go - Tournament Platform</title>
    <!-- Bootstrap 6 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@6.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --accent-color: #ff6b6b;
            --dark-color: #2c2c54;
            --light-color: #f7f7f7;
        }
        
        body {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: #333;
            min-height: 100vh;
        }
        
        .main-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, var(--dark-color), var(--primary-color));
            color: white;
            padding: 15px 0;
        }
        
        .logo {
            font-weight: 800;
            font-size: 24px;
            color: white;
        }
        
        .profile-card {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .tournament-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        
        .tournament-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .tournament-poster {
            height: 180px;
            object-fit: cover;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .moderator-badge {
            display: inline-block;
            background: linear-gradient(to right, #ff9a9e, #fad0c4);
            color: #fff;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .search-bar {
            border-radius: 20px;
            border: none;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .post-card {
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .post-author-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .banner-section {
            margin-bottom: 20px;
        }
        
        .banner-img {
            border-radius: 10px;
            height: 200px;
            object-fit: cover;
            width: 100%;
        }
        
        .announcement-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 350px;
            display: none;
        }
        
        .support-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        
        .wallet-section {
            background: linear-gradient(to right, #0ba360, #3cba92);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .login-modal .modal-content {
            border-radius: 15px;
            overflow: hidden;
        }
        
        .login-tab {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 5px;
        }
        
        .nav-tabs .nav-link {
            color: var(--dark-color);
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="logo">Fram & Go</div>
                <div class="search-bar-container w-50">
                    <input type="text" class="form-control search-bar" placeholder="Search Player, Tournament, Post...">
                </div>
                <div>
                    <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#loginModal" id="loginBtn">Login</button>
                    <button class="btn btn-light" id="profileBtn" style="display: none;">Profile</button>
                    <button class="btn btn-outline-light ms-2" id="logoutBtn" style="display: none;">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container main-container">
        <!-- Profile Info (visible after login) -->
        <div class="row mt-3" id="profileInfo" style="display: none;">
            <div class="col-md-4">
                <div class="profile-card">
                    <div class="d-flex align-items-center">
                        <img src="https://i.ibb.co/4Zj3ZhS/default-avatar.jpg" id="profileImg" class="rounded-circle me-3" width="60" height="60">
                        <div>
                            <h5 id="userName">Player Name</h5>
                            <div>
                                <span id="userRole">Player</span>
                                <span class="moderator-badge" id="modBadge" style="display: none;">‚≠ê Moderator</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="wallet-section">
                    <h6>Wallet Balance</h6>
                    <h3 id="walletBalance">0 BDT</h3>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#walletModal">Manage</button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="profile-card" style="background: linear-gradient(to right, #ff758c, #ff7eb3);">
                    <h6>Total Income</h6>
                    <h3 id="totalIncome">0 BDT</h3>
                    <small>From tournament winnings</small>
                </div>
            </div>
        </div>

        <!-- Banner Section -->
        <div class="row mt-4 banner-section">
            <div class="col-12">
                <div id="tournamentBanner" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <img src="https://i.ibb.co/0Q6R6y0/esports-banner.jpg" class="d-block w-100 banner-img" alt="Tournament Banner">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tournament Section -->
        <div class="row mt-4">
            <div class="col-12">
                <h4 class="mb-4">Available Tournaments</h4>
            </div>
        </div>
        <div class="row" id="tournamentsContainer">
            <!-- Tournaments will be loaded here dynamically -->
        </div>

        <!-- Post Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>Community Posts</h4>
                    <button class="btn btn-primary" id="createPostBtn" style="display: none;">Create Post</button>
                </div>
                <div id="postsContainer">
                    <!-- Posts will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Support Button -->
    <div class="support-btn" data-bs-toggle="modal" data-bs-target="#supportModal">
        <i class="fas fa-headset fa-2x"></i>
    </div>

    <!-- Announcement Popup -->
    <div class="announcement-popup" id="announcementPopup">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Announcement</h6>
                <button type="button" class="btn-close" id="closeAnnouncement"></button>
            </div>
            <div class="card-body">
                <p id="announcementText">Important announcement will appear here.</p>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade login-modal" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="login-tab">
                    <h5 class="mb-0">Login / Register</h5>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs nav-justified mb-3">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#login">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#register">Register</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#guest">Guest</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Login Tab -->
                        <div class="tab-pane fade show active" id="login">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="loginEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="loginEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="loginPassword" required>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="rememberMe">
                                    <label class="form-check-label" for="rememberMe">Remember me</label>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Login</button>
                            </form>
                            <div class="text-center mt-3">
                                <a href="#" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">Forgot Password?</a>
                            </div>
                        </div>

                        <!-- Register Tab -->
                        <div class="tab-pane fade" id="register">
                            <form id="registerForm">
                                <div class="mb-3">
                                    <label for="registerName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="registerName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="registerEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerFFID" class="form-label">Free Fire ID</label>
                                    <input type="text" class="form-control" id="registerFFID" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="registerPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerConfirmPassword" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="registerConfirmPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Register</button>
                            </form>
                        </div>

                        <!-- Guest Tab -->
                        <div class="tab-pane fade" id="guest">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i> As a guest, you can browse tournaments but cannot join them.
                            </div>
                            <button type="button" class="btn btn-secondary w-100" id="guestLoginBtn">Continue as Guest</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div class="modal fade" id="walletModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Wallet Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs nav-justified mb-3">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#deposit">Deposit</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#withdraw">Withdraw</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#transactions">Transactions</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Deposit Tab -->
                        <div class="tab-pane fade show active" id="deposit">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i> Minimum deposit: 10 BDT
                            </div>
                            <form id="depositForm">
                                <div class="mb-3">
                                    <label for="depositAmount" class="form-label">Amount (BDT)</label>
                                    <input type="number" class="form-control" id="depositAmount" min="10" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Payment Method</label>
                                    <select class="form-select" id="depositMethod">
                                        <option value="bkash">bKash</option>
                                        <option value="rocket">Rocket</option>
                                        <option value="nagad">Nagad</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <p>Send money to: <strong>01767882562</strong></p>
                                    <p>Use your User ID as reference</p>
                                </div>
                                <div class="mb-3">
                                    <label for="transactionId" class="form-label">Transaction ID</label>
                                    <input type="text" class="form-control" id="transactionId" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Submit Deposit Request</button>
                            </form>
                        </div>

                        <!-- Withdraw Tab -->
                        <div class="tab-pane fade" id="withdraw">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i> Minimum withdrawal: 50 BDT
                            </div>
                            <form id="withdrawForm">
                                <div class="mb-3">
                                    <label for="withdrawAmount" class="form-label">Amount (BDT)</label>
                                    <input type="number" class="form-control" id="withdrawAmount" min="50" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Payment Method</label>
                                    <select class="form-select" id="withdrawMethod">
                                        <option value="bkash">bKash</option>
                                        <option value="rocket">Rocket</option>
                                        <option value="nagad">Nagad</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="withdrawNumber" class="form-label">Account Number</label>
                                    <input type="text" class="form-control" id="withdrawNumber" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Request Withdrawal</button>
                            </form>
                        </div>

                        <!-- Transactions Tab -->
                        <div class="tab-pane fade" id="transactions">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsList">
                                        <!-- Transactions will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Modal -->
    <div class="modal fade" id="supportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Support Center</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="supportForm">
                        <div class="mb-3">
                            <label for="supportSubject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="supportSubject" required>
                        </div>
                        <div class="mb-3">
                            <label for="supportMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="supportMessage" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Submit Ticket</button>
                    </form>
                    <div class="mt-4">
                        <h6>Your Support Tickets</h6>
                        <div id="supportTicketsList">
                            <!-- Support tickets will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div class="modal fade" id="createPostModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createPostForm">
                        <div class="mb-3">
                            <label for="postTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="postTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="postContent" class="form-label">Content</label>
                            <textarea class="form-control" id="postContent" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="postImage" class="form-label">Image (optional)</label>
                            <input type="file" class="form-control" id="postImage" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Publish Post</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@6.0.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase App (core) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhSjh1VxQFrzslIwOZ1yOxLYuNT2Le_sg",
            authDomain: "fram-and-go.firebaseapp.com",
            databaseURL: "https://fram-and-go-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fram-and-go",
            storageBucket: "fram-and-go.firebasestorage.app",
            messagingSenderId: "781295119002",
            appId: "1:781295119002:web:3d84890a0bb85e5d1c0d23",
            measurementId: "G-H30RNBNE6X"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ImgBB API Key
        const imgbbApiKey = "a5e9f23952de30236c940c60b740ec9d";

        // Global user data
        let currentUser = null;
        let userData = null;

        // DOM Ready
        $(document).ready(function() {
            // Check authentication state
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    $("#loginBtn").hide();
                    $("#profileBtn").show();
                    $("#logoutBtn").show();
                    $("#profileInfo").show();
                    $("#loginModal").modal('hide');
                } else {
                    currentUser = null;
                    userData = null;
                    $("#loginBtn").show();
                    $("#profileBtn").hide();
                    $("#logoutBtn").hide();
                    $("#profileInfo").hide();
                    $("#createPostBtn").hide();
                }
            });

            // Load tournaments and posts
            loadTournaments();
            loadPosts();
            loadBanners();
            checkAnnouncements();

            // Event Listeners
            $("#logoutBtn").click(() => {
                auth.signOut().then(() => {
                    alert("Logged out successfully");
                }).catch((error) => {
                    alert("Error signing out: " + error.message);
                });
            });

            $("#guestLoginBtn").click(() => {
                $("#loginModal").modal('hide');
                alert("You are browsing as a guest. Sign up to join tournaments!");
            });

            $("#loginForm").submit((e) => {
                e.preventDefault();
                const email = $("#loginEmail").val();
                const password = $("#loginPassword").val();
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        $("#loginForm")[0].reset();
                    })
                    .catch((error) => {
                        alert("Login error: " + error.message);
                    });
            });

            $("#registerForm").submit((e) => {
                e.preventDefault();
                const name = $("#registerName").val();
                const email = $("#registerEmail").val();
                const ffid = $("#registerFFID").val();
                const password = $("#registerPassword").val();
                const confirmPassword = $("#registerConfirmPassword").val();
                
                if (password !== confirmPassword) {
                    alert("Passwords don't match!");
                    return;
                }
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        
                        // Save user data to database
                        const userData = {
                            name: name,
                            email: email,
                            ffid: ffid,
                            role: "player",
                            wallet: 0,
                            income: 0,
                            joined: Date.now()
                        };
                        
                        database.ref('users/' + user.uid).set(userData)
                            .then(() => {
                                $("#registerForm")[0].reset();
                                alert("Registration successful!");
                            })
                            .catch((error) => {
                                alert("Error saving user data: " + error.message);
                            });
                    })
                    .catch((error) => {
                        alert("Registration error: " + error.message);
                    });
            });

            $("#createPostBtn").click(() => {
                $("#createPostModal").modal('show');
            });

            $("#createPostForm").submit((e) => {
                e.preventDefault();
                if (!currentUser || !userData || (userData.role !== 'moderator' && userData.role !== 'admin')) {
                    alert("Only moderators and admins can create posts.");
                    return;
                }
                
                const title = $("#postTitle").val();
                const content = $("#postContent").val();
                const imageFile = $("#postImage")[0].files[0];
                
                if (imageFile) {
                    // Upload image to ImgBB
                    const formData = new FormData();
                    formData.append("image", imageFile);
                    
                    fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                        method: "POST",
                        body: formData
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            createPost(title, content, result.data.url);
                        } else {
                            alert("Image upload failed");
                        }
                    })
                    .catch(error => {
                        alert("Image upload error: " + error.message);
                    });
                } else {
                    createPost(title, content, null);
                }
            });

            $("#closeAnnouncement").click(() => {
                $("#announcementPopup").hide();
            });

            $("#depositForm").submit((e) => {
                e.preventDefault();
                if (!currentUser) {
                    alert("Please login first");
                    return;
                }
                
                const amount = parseInt($("#depositAmount").val());
                const method = $("#depositMethod").val();
                const transactionId = $("#transactionId").val();
                
                // Create transaction record
                const transactionData = {
                    type: "deposit",
                    amount: amount,
                    method: method,
                    transactionId: transactionId,
                    status: "pending",
                    timestamp: Date.now(),
                    userId: currentUser.uid
                };
                
                database.ref('transactions').push(transactionData)
                    .then(() => {
                        $("#depositForm")[0].reset();
                        alert("Deposit request submitted. Waiting for admin approval.");
                        $("#walletModal").modal('hide');
                    })
                    .catch((error) => {
                        alert("Error submitting deposit: " + error.message);
                    });
            });

            $("#withdrawForm").submit((e) => {
                e.preventDefault();
                if (!currentUser || !userData) {
                    alert("Please login first");
                    return;
                }
                
                const amount = parseInt($("#withdrawAmount").val());
                const method = $("#withdrawMethod").val();
                const accountNumber = $("#withdrawNumber").val();
                
                if (amount > userData.wallet) {
                    alert("Insufficient balance");
                    return;
                }
                
                // Create transaction record
                const transactionData = {
                    type: "withdraw",
                    amount: amount,
                    method: method,
                    accountNumber: accountNumber,
                    status: "pending",
                    timestamp: Date.now(),
                    userId: currentUser.uid
                };
                
                database.ref('transactions').push(transactionData)
                    .then(() => {
                        $("#withdrawForm")[0].reset();
                        alert("Withdrawal request submitted. Waiting for admin approval.");
                        $("#walletModal").modal('hide');
                    })
                    .catch((error) => {
                        alert("Error submitting withdrawal: " + error.message);
                    });
            });

            $("#supportForm").submit((e) => {
                e.preventDefault();
                if (!currentUser) {
                    alert("Please login first");
                    return;
                }
                
                const subject = $("#supportSubject").val();
                const message = $("#supportMessage").val();
                
                const ticketData = {
                    subject: subject,
                    message: message,
                    status: "open",
                    timestamp: Date.now(),
                    userId: currentUser.uid,
                    userName: userData.name
                };
                
                database.ref('supportTickets').push(ticketData)
                    .then(() => {
                        $("#supportForm")[0].reset();
                        alert("Support ticket submitted successfully.");
                        loadSupportTickets();
                    })
                    .catch((error) => {
                        alert("Error submitting ticket: " + error.message);
                    });
            });
        });

        // Load user data from database
        function loadUserData(userId) {
            database.ref('users/' + userId).on('value', (snapshot) => {
                userData = snapshot.val();
                if (userData) {
                    $("#userName").text(userData.name);
                    $("#walletBalance").text(userData.wallet + " BDT");
                    $("#totalIncome").text(userData.income + " BDT");
                    
                    if (userData.role === "moderator") {
                        $("#userRole").text("Moderator");
                        $("#modBadge").show();
                        $("#createPostBtn").show();
                    } else if (userData.role === "admin") {
                        $("#userRole").text("Admin");
                        $("#modBadge").show();
                        $("#createPostBtn").show();
                    } else {
                        $("#userRole").text("Player");
                        $("#modBadge").hide();
                        $("#createPostBtn").hide();
                    }
                    
                    if (userData.profileImage) {
                        $("#profileImg").attr("src", userData.profileImage);
                    }
                    
                    loadTransactions();
                    loadSupportTickets();
                }
            });
        }

        // Load tournaments from database
        function loadTournaments() {
            database.ref('tournaments').on('value', (snapshot) => {
                const tournaments = snapshot.val();
                const container = $("#tournamentsContainer");
                container.empty();
                
                if (tournaments) {
                    Object.entries(tournaments).forEach(([id, tournament]) => {
                        if (tournament.status !== "closed") {
                            const card = createTournamentCard(id, tournament);
                            container.append(card);
                        }
                    });
                } else {
                    container.html('<div class="col-12 text-center"><p>No tournaments available at the moment.</p></div>');
                }
            });
        }

        // Create tournament card HTML
        function createTournamentCard(id, tournament) {
            let statusClass = "bg-warning";
            if (tournament.status === "open") statusClass = "bg-success";
            if (tournament.status === "full") statusClass = "bg-danger";
            
            let playersText = "No players yet";
            if (tournament.players) {
                const playerCount = Object.keys(tournament.players).length;
                playersText = `${playerCount} / ${tournament.maxPlayers || 50} players`;
            }
            
            return `
                <div class="col-md-6 col-lg-4">
                    <div class="card tournament-card">
                        <div class="position-relative">
                            <img src="${tournament.poster || 'https://i.ibb.co/0Q6R6y0/esports-banner.jpg'}" class="card-img-top tournament-poster" alt="${tournament.name}">
                            <span class="status-badge ${statusClass}">${tournament.status}</span>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${tournament.name}</h5>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-primary">${tournament.type}</span>
                                <span>${playersText}</span>
                            </div>
                            <p class="card-text"><i class="fas fa-calendar me-2"></i>${new Date(tournament.date).toLocaleDateString()}</p>
                            <p class="card-text"><i class="fas fa-trophy me-2"></i>Prize: ${tournament.prizePool} BDT</p>
                            <p class="card-text"><i class="fas fa-ticket-alt me-2"></i>Entry: ${tournament.entryFee} BDT</p>
                            <button class="btn btn-primary w-100 join-tournament" data-id="${id}">Join Tournament</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load posts from database
        function loadPosts() {
            database.ref('posts').on('value', (snapshot) => {
                const posts = snapshot.val();
                const container = $("#postsContainer");
                container.empty();
                
                if (posts) {
                    Object.entries(posts).forEach(([id, post]) => {
                        const postElement = createPostElement(id, post);
                        container.append(postElement);
                    });
                } else {
                    container.html('<div class="text-center"><p>No posts yet.</p></div>');
                }
            });
        }

        // Create post element HTML
        function createPostElement(id, post) {
            return `
                <div class="card post-card mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <img src="${post.authorImage || 'https://i.ibb.co/4Zj3ZhS/default-avatar.jpg'}" class="post-author-img me-3">
                            <div>
                                <h6 class="mb-0">${post.authorName}</h6>
                                <small class="text-muted">${new Date(post.timestamp).toLocaleDateString()}</small>
                            </div>
                        </div>
                        <h5 class="card-title">${post.title}</h5>
                        <p class="card-text">${post.content}</p>
                        ${post.image ? `<img src="${post.image}" class="img-fluid rounded mb-3">` : ''}
                        <div class="d-flex justify-content-between">
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2"><i class="fas fa-heart"></i> Like (${post.likes || 0})</button>
                                <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-comment"></i> Comment</button>
                            </div>
                            <button class="btn btn-sm btn-outline-info"><i class="fas fa-share"></i> Share</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create a new post
        function createPost(title, content, imageUrl) {
            if (!currentUser || !userData) return;
            
            const postData = {
                title: title,
                content: content,
                image: imageUrl || null,
                authorId: currentUser.uid,
                authorName: userData.name,
                authorImage: userData.profileImage || null,
                timestamp: Date.now(),
                likes: 0,
                comments: {}
            };
            
            database.ref('posts').push(postData)
                .then(() => {
                    $("#createPostForm")[0].reset();
                    $("#createPostModal").modal('hide');
                    alert("Post published successfully!");
                })
                .catch((error) => {
                    alert("Error publishing post: " + error.message);
                });
        }

        // Load banners from database
        function loadBanners() {
            database.ref('banners').on('value', (snapshot) => {
                const banners = snapshot.val();
                const carousel = $("#tournamentBanner .carousel-inner");
                carousel.empty();
                
                if (banners) {
                    let first = true;
                    Object.entries(banners).forEach(([id, banner]) => {
                        if (banner.active) {
                            const item = `
                                <div class="carousel-item ${first ? 'active' : ''}">
                                    <img src="${banner.imageUrl}" class="d-block w-100 banner-img" alt="Tournament Banner">
                                </div>
                            `;
                            carousel.append(item);
                            first = false;
                        }
                    });
                    
                    if (!first) {
                        $("#tournamentBanner").show();
                    } else {
                        $("#tournamentBanner").hide();
                    }
                } else {
                    $("#tournamentBanner").hide();
                }
            });
        }

        // Check for announcements
        function checkAnnouncements() {
            database.ref('announcements').on('value', (snapshot) => {
                const announcements = snapshot.val();
                const popup = $("#announcementPopup");
                
                if (announcements) {
                    Object.entries(announcements).forEach(([id, announcement]) => {
                        if (announcement.active && !localStorage.getItem(`announcement_${id}_dismissed`)) {
                            $("#announcementText").text(announcement.text);
                            popup.show();
                        }
                    });
                }
            });
        }

        // Load transactions for current user
        function loadTransactions() {
            if (!currentUser) return;
            
            database.ref('transactions').orderByChild('userId').equalTo(currentUser.uid).on('value', (snapshot) => {
                const transactions = snapshot.val();
                const list = $("#transactionsList");
                list.empty();
                
                if (transactions) {
                    Object.entries(transactions).forEach(([id, transaction]) => {
                        const row = `
                            <tr>
                                <td>${new Date(transaction.timestamp).toLocaleDateString()}</td>
                                <td>${transaction.type}</td>
                                <td>${transaction.amount} BDT</td>
                                <td><span class="badge ${getStatusBadgeClass(transaction.status)}">${transaction.status}</span></td>
                            </tr>
                        `;
                        list.append(row);
                    });
                } else {
                    list.append('<tr><td colspan="4" class="text-center">No transactions yet.</td></tr>');
                }
            });
        }

        // Get badge class based on status
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'approved': return 'bg-success';
                case 'pending': return 'bg-warning';
                case 'rejected': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // Load support tickets for current user
        function loadSupportTickets() {
            if (!currentUser) return;
            
            database.ref('supportTickets').orderByChild('userId').equalTo(currentUser.uid).on('value', (snapshot) => {
                const tickets = snapshot.val();
                const list = $("#supportTicketsList");
                list.empty();
                
                if (tickets) {
                    Object.entries(tickets).forEach(([id, ticket]) => {
                        const ticketElement = `
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="card-title mb-1">${ticket.subject}</h6>
                                        <span class="badge ${getStatusBadgeClass(ticket.status)}">${ticket.status}</span>
                                    </div>
                                    <p class="card-text small mb-1">${ticket.message}</p>
                                    <small class="text-muted">${new Date(ticket.timestamp).toLocaleDateString()}</small>
                                </div>
                            </div>
                        `;
                        list.append(ticketElement);
                    });
                } else {
                    list.append('<p class="text-center">No support tickets yet.</p>');
                }
            });
        }

        // Handle tournament join button clicks
        $(document).on('click', '.join-tournament', function() {
            if (!currentUser) {
                alert("Please login to join tournaments");
                $("#loginModal").modal('show');
                return;
            }
            
            const tournamentId = $(this).data('id');
            joinTournament(tournamentId);
        });

        // Join a tournament
        function joinTournament(tournamentId) {
            database.ref('tournaments/' + tournamentId).once('value')
                .then((snapshot) => {
                    const tournament = snapshot.val();
                    
                    // Check if tournament is full
                    const playerCount = tournament.players ? Object.keys(tournament.players).length : 0;
                    if (tournament.status === "full" || playerCount >= (tournament.maxPlayers || 50)) {
                        alert("This tournament is already full");
                        return;
                    }
                    
                    // Check if user has enough balance
                    if (userData.wallet < tournament.entryFee) {
                        alert("Insufficient balance. Please deposit funds to your wallet.");
                        $("#walletModal").modal('show');
                        return;
                    }
                    
                    // Check if user is already registered
                    if (tournament.players && tournament.players[currentUser.uid]) {
                        alert("You are already registered for this tournament");
                        return;
                    }
                    
                    // Register user for tournament
                    const playerData = {
                        name: userData.name,
                        ffid: userData.ffid,
                        joined: Date.now()
                    };
                    
                    database.ref('tournaments/' + tournamentId + '/players/' + currentUser.uid).set(playerData)
                        .then(() => {
                            // Deduct entry fee from wallet
                            const newWalletBalance = userData.wallet - tournament.entryFee;
                            database.ref('users/' + currentUser.uid + '/wallet').set(newWalletBalance)
                                .then(() => {
                                    alert("Successfully joined the tournament!");
                                    
                                    // Update tournament player count
                                    const newPlayerCount = playerCount + 1;
                                    if (newPlayerCount >= (tournament.maxPlayers || 50)) {
                                        database.ref('tournaments/' + tournamentId + '/status').set("full");
                                    }
                                });
                        })
                        .catch((error) => {
                            alert("Error joining tournament: " + error.message);
                        });
                });
        }
    </script>
</body>
</html>
